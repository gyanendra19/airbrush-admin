<!-- Add Font Awesome CDN in the head section -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<div class="section-content">
  <h2 class="h4 mb-3">Ghibli Hero Configuration</h2>

  <div class="card border-0 shadow-lg overflow-hidden">
  <div class="card-body p-4">
    <!-- Header with subtle accent -->
    <div class="mb-4 pb-2 border-bottom">
      <h5 class="fw-semibold mb-0 text-primary">Banner Editor</h5>
      <p class="small text-muted mb-0">Customize your Studio Ghibli showcase</p>
    </div>

    <form class="needs-validation" novalidate>
      <!-- Title/Subtitle Group (Improved spacing + floating labels) -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="form-floating">
            <input type="text" 
                   class="form-control" 
                   id="banner-title" 
                   value="Studio Ghibli Showcase"
                   placeholder="Title"
                   required>
            <label for="banner-title" class="text-muted">Title</label>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-floating">
            <input type="text" 
                   class="form-control" 
                   id="banner-subtitle" 
                   value="Explore the magical world"
                   placeholder="Subtitle">
            <label for="banner-subtitle" class="text-muted">Subtitle</label>
          </div>
        </div>
      </div>

      <!-- Image Gallery (Modern masonry grid + hover effects) -->
      <div class="mb-4">
        <label class="form-label small text-uppercase fw-semibold text-muted mb-2">Gallery</label>
        <div class="row g-3" id="image-preview-container">
          <!-- Single Image Card with replace button -->
          <div class="col-12">
            <div class="d-flex align-items-center gap-3 p-3 bg-light rounded-3">
              <div class="ratio ratio-4x3" style="width: 300px;">
                <img src="https://res.cloudinary.com/dlzk6nqyg/image/upload/v1744960427/uploads/v3hohxrnlxwqttyiq5bm.jpg"
                     class="object-fit-contain rounded"
                     alt="Ghibli Image">
                <button class="btn-replace-image btn btn-sm btn-outline-primary position-absolute top-0 end-0 m-1">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1">Current Image</h6>
                <p class="small text-muted mb-0">Click the replace button to change the image</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons (Sticky bottom with gradient) -->
      <div class="pt-4 mt-4 border-top">
        <div class="d-flex justify-content-end gap-3">
          <button type="button" class="btn btn-outline-secondary px-4 rounded-pill">Cancel</button>
          <button type="submit" class="btn btn-primary px-4 rounded-pill shadow-sm">
            <i class="bi bi-check-lg me-2"></i>Save Changes
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Add alert container at the end of the body -->
<div class="alert-container position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
  <div id="heroSuccessAlert" class="alert alert-success d-flex align-items-center mb-0 d-none">
    <i class="bi bi-check-circle-fill me-2"></i>
    <div>
      <strong>Success!</strong> Your changes have been saved.
    </div>
  </div>
</div>

<style>
  .compact-form .form-control-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }
  .img-cover {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .hover-zoom:hover img {
    transform: scale(1.05);
    transition: transform 0.3s ease;
  }
  .border-dashed {
    border-style: dashed !important;
  }
  .transition-all {
    transition: all 0.2s ease;
  }
  .hover-shadow-lg:hover {
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
  }

  /* Override Bootstrap's ratio positioning for buttons */
  .ratio .btn-replace-image {
    position: absolute;
    left: auto !important; 
    top: 0;
    right: 0;
    width: 36px;
    height: 36px;
    z-index: 10;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .ratio .btn-replace-image:hover {
    background: white;
    transform: rotate(180deg);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  .ratio .btn-replace-image i {
    font-size: 1.1rem;
    color: #0d6efd;
  }

  .ratio .btn-replace-image:hover i {
    color: #0a58ca;
  }

  /* Ensure the image container has proper padding */
  .ratio.ratio-4x3 {
    padding: 10px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  /* Make sure the image fits properly */
  .object-fit-contain {
    object-fit: contain !important;
    max-width: 100%;
    max-height: 100%;
  }

  /* Alert container styles */
  .alert-container {
    min-width: 300px;
    max-width: 500px;
  }

  .alert-container .alert {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border: none;
    animation: slideIn 0.3s ease-out;
    margin-bottom: 0;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
</style>

<script>
  // Only execute this code when hero-section is loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Hide any existing alerts when page loads
    const successAlert = document.getElementById('heroSuccessAlert');
    if (successAlert) {
      successAlert.classList.add('d-none');
    }

    // Check if we're on the hero section page
    if (window.location.pathname.includes('hero-section')) {
      // Get content ID and category from the URL
      const urlParams = new URLSearchParams(window.location.search);
      
      // Get content ID from the link that was clicked
      const getContentId = () => {
        // Get from URL parameters
        if (urlParams.has('id')) {
          return urlParams.get('id');
        }
        
        // Fallback: check for data-content-id attribute (for backward compatibility)
        if (document.referrer.includes('/hero-section')) {
          const sidebarLink = document.querySelector('a[href="/hero-section"]');
          if (sidebarLink && sidebarLink.getAttribute('data-content-id')) {
            return sidebarLink.getAttribute('data-content-id');
          }
        }
        
        return null;
      };
      
      const contentId = getContentId();
      const category = urlParams.get('category');
      
      console.log('Content ID:', contentId);
      console.log('Category:', category);
      
      // Current media content holder
      let currentMedia = null;
      
      // Handle image replace functionality
      const replaceButton = document.querySelector('.btn-replace-image');
      const mediaUpload = document.createElement('input');
      mediaUpload.type = 'file';
      mediaUpload.accept = 'image/*,video/*';
      mediaUpload.style.display = 'none';
      document.body.appendChild(mediaUpload);
      
      if (replaceButton) {
        // Trigger file input when replace button is clicked
        replaceButton.addEventListener('click', function() {
          mediaUpload.click();
        });
        
        // Handle file selection
        mediaUpload.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (!file) return;
          
          if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
            // Create object URL for preview
            const objectUrl = URL.createObjectURL(file);
            
            // Prepare media object
            currentMedia = {
              type: file.type.startsWith('image/') ? 'image' : 'video',
              file: file,
              url: objectUrl
            };
            
            // Update gallery with new media
            updateGallery(currentMedia);
            
            // Upload file to server
            uploadMediaToServer(file, contentId).then(response => {
              if (response && response.url) {
                // Update the currentMedia with the server URL
                currentMedia.serverUrl = response.url;
                currentMedia.url = response.url;
                console.log('Media uploaded to server:', response);
              }
            });
          } else {
            alert('Please select an image or video file.');
          }
        });
      }
      
      // Only attempt to fetch if we have a content ID
      if (contentId) {
        fetch(`http://localhost:5000/api/content/id/${contentId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          console.log('API Response:', data);
          // You can handle the data here
          if (data && data.title) {
            document.getElementById('banner-title').value = data.title;
          }
          if (data && data.subtitle) {
            document.getElementById('banner-subtitle').value = data.subtitle;
          }
          // Store current media
          if (data && data.images && Array.isArray(data.images) && data.images.length > 0) {
            // Use the first image in the array
            currentMedia = data.images[0];
            updateGallery(currentMedia);
          }
        })
        .catch(error => {
          console.error('Error fetching data from API:', error);
        });
      } else {
        console.log('No content ID available for fetch request');
      }
      
      // Add event listener to Save Changes button
      const saveButton = document.querySelector('button[type="submit"]');
      if (saveButton) {
        // Prevent the default form submission
        document.querySelector('form.needs-validation').addEventListener('submit', function(e) {
          e.preventDefault();
        });
        
        saveButton.addEventListener('click', function() {
          updateContent(contentId, currentMedia);
        });
      }
    }
  });
  
  // Function to update content via API
  function updateContent(contentId, media) {
    if (!contentId) {
      console.error('No content ID available for update');
      return;
    }
    
    // Get values from form
    const title = document.getElementById('banner-title').value;
    const subtitle = document.getElementById('banner-subtitle').value;
    
    // Prepare data for API
    const updateData = {
      title: title,
      subtitle: subtitle,
      images: []
    };
    
    // Add media if available
    if (media) {
      const mediaUrl = media.serverUrl || media.url;
      const mediaObject = {
        url: mediaUrl,
        alt: title || "Hero media",
        width: 1200,
        height: 800,
        order: 1,
        type: media.type || 'image'
      };
      updateData.images = [mediaObject];
    }
    
    // Show loading state
    const saveButton = document.querySelector('button[type="submit"]');
    const originalButtonText = saveButton.innerHTML;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    saveButton.disabled = true;
    
    // JWT Token for authorization
    const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MDQ5MWRmMzljZmYwNTljMDY1NWZkMSIsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc0NTIyNTEyMSwiZXhwIjoxNzQ1MzExNTIxfQ.O1xfunWURBxt7tqcgXH_yWEyq-7VOA61LX6qrmEHXoA';
    
    // Send update request
    fetch(`http://localhost:5000/api/content/${contentId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(updateData)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Update failed: ' + response.statusText);
      }
      return response.json();
    })
    .then(data => {
      console.log('Update successful:', data);
      
      // Show success message in bottom right
      const successAlert = document.getElementById('heroSuccessAlert');
      if (successAlert) {
        successAlert.classList.remove('d-none');
        
        // Hide after 3 seconds
        setTimeout(() => {
          successAlert.classList.add('d-none');
        }, 3000);
      }
    })
    .catch(error => {
      console.error('Error updating content:', error);
      
      // Show error message in bottom right
      const successAlert = document.getElementById('heroSuccessAlert');
      if (successAlert) {
        successAlert.className = 'alert alert-danger d-flex align-items-center mb-0';
        successAlert.classList.remove('d-none');
        
        // Hide after 3 seconds
        setTimeout(() => {
          successAlert.classList.add('d-none');
          // Reset to success alert for next time
          successAlert.className = 'alert alert-success d-flex align-items-center mb-0 d-none';
          successAlert.innerHTML = `
            <i class="bi bi-check-circle-fill me-2"></i>
            <div>
              <strong>Success!</strong> Your changes have been saved.
            </div>
          `;
        }, 3000);
      }
    })
    .finally(() => {
      // Restore button state
      saveButton.innerHTML = originalButtonText;
      saveButton.disabled = false;
    });
  }

  // Function to update the gallery with images from API
  function updateGallery(content) {
    const galleryContainer = document.getElementById('image-preview-container');
    if (!galleryContainer) return;
    
    // Get the container where we'll put the media
    const mediaContainer = galleryContainer.querySelector('.ratio.ratio-4x3');
    if (!mediaContainer || !content) return;
    
    // Clear existing content
    mediaContainer.innerHTML = '';
    
    // Create the appropriate element based on media type
    if (content.type === 'video') {
      // Create video element
      const videoElement = document.createElement('video');
      videoElement.src = content.url || content;
      videoElement.controls = true;
      videoElement.autoplay = false;
      videoElement.muted = true;
      videoElement.className = 'object-fit-contain rounded w-100 h-100';
      mediaContainer.appendChild(videoElement);
    } else {
      // Create image element (default)
      const imageElement = document.createElement('img');
      imageElement.src = content.url || content;
      imageElement.className = 'object-fit-contain rounded';
      imageElement.alt = "Ghibli Media";
      mediaContainer.appendChild(imageElement);
    }
    
    // Add replace button
    const replaceButton = document.createElement('button');
    replaceButton.className = 'btn-replace-image btn btn-sm btn-outline-primary position-absolute top-0 end-0 m-1';
    replaceButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
    replaceButton.addEventListener('click', function() {
      document.querySelector('input[type="file"]').click();
    });
    mediaContainer.appendChild(replaceButton);
  }

  // Function to upload media to server
  async function uploadMediaToServer(file, contentId) {
    if (!file) return null;
    
    // JWT Token for authorization
    const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MDQ5MWRmMzljZmYwNTljMDY1NWZkMSIsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc0NTEzMDA2MywiZXhwIjoxNzQ1MjE2NDYzfQ.X7iaXBMdl1dYL15owKDCHzaWQpmtD_b74askqD5vasw';
    
    // Create FormData
    const formData = new FormData();
    formData.append('images', file);
    
    try {
      // Show loading indicator
      const loadingIndicator = document.createElement('div');
      loadingIndicator.className = 'position-absolute bg-dark bg-opacity-50 w-100 h-100 d-flex align-items-center justify-content-center text-white';
      loadingIndicator.style.zIndex = '10';
      loadingIndicator.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">Uploading...</span></div>';
      
      // Add loading indicator to the media card
      const mediaCard = document.querySelector('.ratio.ratio-4x3');
      if (mediaCard) {
        mediaCard.style.position = 'relative';
        mediaCard.appendChild(loadingIndicator);
      }
      
      // Upload the media to Cloudinary via your endpoint
      const response = await fetch('http://localhost:5000/api/images', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });
      
      if (!response.ok) {
        throw new Error('Upload failed: ' + response.statusText);
      }
      
      const data = await response.json();
      
      // Remove loading indicator
      if (loadingIndicator) {
        loadingIndicator.remove();
      }
      
      // Return the Cloudinary URL
      if (data && data.files) {
        // Get media type
        const isVideo = file.type.startsWith('video/');
        
        // Update the media container
        updateGallery({
          type: isVideo ? 'video' : 'image',
          url: data.files[0].url
        });
        
        // Return the media data
        return {
          url: data.files[0].url,
          alt: "Uploaded media",
          width: 1200,
          height: 800,
          order: 1,
          type: isVideo ? 'video' : 'image'
        };
      }
      
      return null;
    } catch (error) {
      console.error('Error uploading to Cloudinary:', error);
      
      // Remove loading indicator if it exists
      const loadingIndicator = document.querySelector('.position-absolute.bg-dark.bg-opacity-50');
      if (loadingIndicator) {
        loadingIndicator.remove();
      }
      
      // Show error alert
      alert('Failed to upload media. Please try again.');
      return null;
    }
  }

  // Remove any existing alerts when the page loads
  document.addEventListener('DOMContentLoaded', function() {
    // Remove any existing alerts except our fixed one
    const existingAlerts = document.querySelectorAll('.alert:not(#heroSuccessAlert)');
    existingAlerts.forEach(alert => alert.remove());
    
    // Remove any alert containers except our fixed one
    const alertContainers = document.querySelectorAll('.alert-container:not(.position-fixed)');
    alertContainers.forEach(container => container.remove());
    
    // Remove any alerts that might be in the card body
    const cardBody = document.querySelector('.card-body');
    if (cardBody) {
      const cardAlerts = cardBody.querySelectorAll('.alert');
      cardAlerts.forEach(alert => alert.remove());
    }
  });
</script>