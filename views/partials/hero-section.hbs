<div class="section-content">
  <h2 class="h4 mb-3">Ghibli Hero Configuration</h2>

  <div class="card border-0 shadow-lg overflow-hidden">
  <div class="card-body p-4">
    <!-- Header with subtle accent -->
    <div class="mb-4 pb-2 border-bottom">
      <h5 class="fw-semibold mb-0 text-primary">Banner Editor</h5>
      <p class="small text-muted mb-0">Customize your Studio Ghibli showcase</p>
    </div>

    <form class="needs-validation" novalidate>
      <!-- Title/Subtitle Group (Improved spacing + floating labels) -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="form-floating">
            <input type="text" 
                   class="form-control" 
                   id="banner-title" 
                   value="Studio Ghibli Showcase"
                   placeholder="Title"
                   required>
            <label for="banner-title" class="text-muted">Title</label>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-floating">
            <input type="text" 
                   class="form-control" 
                   id="banner-subtitle" 
                   value="Explore the magical world"
                   placeholder="Subtitle">
            <label for="banner-subtitle" class="text-muted">Subtitle</label>
          </div>
        </div>
      </div>

      <!-- Image Gallery (Modern masonry grid + hover effects) -->
      <div class="mb-4">
        <label class="form-label small text-uppercase fw-semibold text-muted mb-2">Hero Image</label>
        <div class="row g-3" id="image-preview-container">
          <!-- Single Image Card with hover zoom -->
          <div class="col-12">
            <div class="position-relative rounded-3 overflow-hidden hover-zoom" style="height: 300px; background-color: #f8f9fa;">
              <img src="https://res.cloudinary.com/dlzk6nqyg/image/upload/v1744960427/uploads/v3hohxrnlxwqttyiq5bm.jpg"
                   class="w-100 h-100"
                   style="object-fit: contain; object-position: left; background-color: #f8f9fa;"
                   alt="Hero Image">
              <button class="btn-replace-image btn btn-sm btn-primary position-absolute top-0 end-0 m-2 d-flex align-items-center justify-content-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#0d6efd" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                  <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                </svg>
              </button>
            </div>
          </div>
          
          <!-- Add Image Card (Hidden by default, shown only when no image exists) -->
          <div class="col-12 d-none" id="add-image-btn">
            <div class="position-relative rounded-3 bg-light border-2 border-dashed hover-shadow-lg cursor-pointer d-flex align-items-center justify-content-center transition-all" style="height: 300px;">
              <div class="text-center p-2">
                <i class="bi bi-plus-lg fs-5 text-primary"></i>
                <p class="small text-muted mb-0">Add Hero Image</p>
              </div>
              <input type="file" id="media-upload" accept="image/*" class="d-none">
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons (Sticky bottom with gradient) -->
      <div class="pt-4 mt-4 border-top">
        <div class="d-flex justify-content-end gap-3">
          <button type="button" class="btn btn-outline-secondary px-4 rounded-pill">Cancel</button>
          <button type="submit" class="btn btn-primary px-4 rounded-pill shadow-sm">
            <i class="bi bi-check-lg me-2"></i>Save Changes
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<style>
  .compact-form .form-control-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }
  .img-cover {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .hover-zoom {
    transition: transform 0.3s ease;
  }

  .hover-zoom:hover {
    transform: scale(1.02);
  }

  .hover-zoom img {
    transition: transform 0.3s ease;
  }

  .hover-zoom:hover img {
    transform: scale(1.05);
  }

  .border-dashed {
    border-style: dashed !important;
  }
  .transition-all {
    transition: all 0.2s ease;
  }
  .hover-shadow-lg:hover {
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
  }

  /* Override Bootstrap's ratio positioning for buttons */
  .btn-replace-image {
    position: absolute;
    left: auto !important; 
    top: 0;
    right: 0;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.2s ease;
    width: 32px;
    height: 32px;
    padding: 0;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .position-relative:hover .btn-replace-image {
    opacity: 1;
  }

  .btn-replace-image:hover {
    background-color: rgba(255, 255, 255, 1);
    transform: scale(1.05);
  }

  .btn-replace-image svg {
    width: 16px;
    height: 16px;
  }

  /* Ensure image container has proper background */
  .position-relative {
    background-color: #f8f9fa;
  }

  .ratio {
    background-color: #f8f9fa;
  }

  .ratio img {
    object-fit: cover;
    width: 100%;
    height: 100%;
  }
</style>

<script>
  // Only execute this code when hero-section is loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Check if we're on the hero section page
    if (window.location.pathname.includes('hero-section')) {
      // Get content ID and category from the URL
      const urlParams = new URLSearchParams(window.location.search);
      
      // Get content ID from the link that was clicked
      const getContentId = () => {
        // Get from URL parameters
        if (urlParams.has('id')) {
          return urlParams.get('id');
        }
        
        // Fallback: check for data-content-id attribute (for backward compatibility)
        if (document.referrer.includes('/hero-section')) {
          const sidebarLink = document.querySelector('a[href="/hero-section"]');
          if (sidebarLink && sidebarLink.getAttribute('data-content-id')) {
            return sidebarLink.getAttribute('data-content-id');
          }
        }
        
        return null;
      };
      
      const contentId = getContentId();
      const category = urlParams.get('category');
      
      console.log('Content ID:', contentId);
      console.log('Category:', category);
      
      // Current media content holder
      let currentMedia = null;
      
      // Handle image upload functionality
      const addImageBtn = document.getElementById('add-image-btn');
      const mediaUpload = document.getElementById('media-upload');
      
      if (addImageBtn && mediaUpload) {
        // Trigger file input when add image button is clicked
        addImageBtn.addEventListener('click', function() {
          mediaUpload.click();
        });
        
        // Handle file selection
        mediaUpload.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (!file) return;
          
          // Check if file is an image
          if (file.type.startsWith('image/')) {
            // Create object URL for preview
            const objectUrl = URL.createObjectURL(file);
            
            // Prepare media object
            currentMedia = {
              type: 'image',
              file: file,
              url: objectUrl
            };
            
            // Update gallery with new media immediately
            updateGallery(currentMedia);
            
            // Upload file to server
            uploadMediaToServer(file, contentId).then(response => {
              if (response && response.url) {
                // Update the currentMedia with the server URL
                currentMedia.serverUrl = response.url;
                currentMedia.url = response.url;
                // Update the gallery again with the final URL
                updateGallery(currentMedia);
              }
            });
          } else {
            alert('Please select an image file.');
          }
        });
      }
      
      // Only attempt to fetch if we have a content ID
      if (contentId) {
        fetch(`http://localhost:5000/api/content/id/${contentId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          console.log('API Response:', data);
          // You can handle the data here
          if (data && data.title) {
            document.getElementById('banner-title').value = data.title;
          }
          if (data && data.subtitle) {
            document.getElementById('banner-subtitle').value = data.subtitle;
          }
          // Store current media
          if (data && data.images && Array.isArray(data.images) && data.images.length > 0) {
            // Use the first image in the array
            currentMedia = data.images[0];
            updateGallery(currentMedia);
          }
        })
        .catch(error => {
          console.error('Error fetching data from API:', error);
        });
      } else {
        console.log('No content ID available for fetch request');
      }
      
      // Add event listener to Save Changes button
      const saveButton = document.querySelector('button[type="submit"]');
      if (saveButton) {
        // Prevent the default form submission
        document.querySelector('form.needs-validation').addEventListener('submit', function(e) {
          e.preventDefault();
        });
        
        saveButton.addEventListener('click', function() {
          updateContent(contentId, currentMedia);
        });
      }

      // Set up replace button for existing image
      const initialReplaceBtn = document.querySelector('.btn-replace-image');
      if (initialReplaceBtn) {
        initialReplaceBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (mediaUpload) {
            mediaUpload.click();
          }
        });
      }

      // Update the event listeners
      const fileInput = document.getElementById('media-upload');
      if (fileInput) {
        // Remove any existing event listeners
        fileInput.removeEventListener('change', handleFileSelect);
        // Add the new event listener
        fileInput.addEventListener('change', handleFileSelect);
      }

      const replaceButton = document.querySelector('.btn-replace-image');
      if (replaceButton && fileInput) {
        replaceButton.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          fileInput.click();
        });
      }
    }
  });
  
  // Function to update content via API
  function updateContent(contentId, media) {
    if (!contentId) {
      console.error('No content ID available for update');
      return;
    }
    
    // Get values from form
    const title = document.getElementById('banner-title').value;
    const subtitle = document.getElementById('banner-subtitle').value;
    
    // Prepare data for API
    const updateData = {
      title: title,
      subtitle: subtitle,
      images: []
    };
    
    // Add media if available
    if (media) {
      // Use the Cloudinary URL if available, otherwise use the local URL
      const mediaUrl = media.serverUrl || media.url;
      
      // Create image object with structure matching MongoDB
      const imageObject = {
        url: mediaUrl,
        alt: title || "Hero image", // Use title as alt text, or default
        width: 1200, // Default width
        height: 800, // Default height
        order: 1 // First image
      };
      
      // Add to images array
      updateData.images = [imageObject];
      
      console.log('Saving image with data:', imageObject);
    }
    
    // Show loading state
    const saveButton = document.querySelector('button[type="submit"]');
    const originalButtonText = saveButton.innerHTML;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    saveButton.disabled = true;
    
    // JWT Token for authorization
    const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MDQ5MWRmMzljZmYwNTljMDY1NWZkMSIsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc0NTIyNTEyMSwiZXhwIjoxNzQ1MzExNTIxfQ.O1xfunWURBxt7tqcgXH_yWEyq-7VOA61LX6qrmEHXoA';
    
    // Send update request
    fetch(`http://localhost:5000/api/content/${contentId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(updateData)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Update failed: ' + response.statusText);
      }
      return response.json();
    })
    .then(data => {
      console.log('Update successful:', data);
      
      // Show success message
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-success alert-dismissible fade show';
      alertDiv.innerHTML = `
        <strong>Success!</strong> Your changes have been saved.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      document.querySelector('.card-body').prepend(alertDiv);
      
      // Remove alert after 3 seconds
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    })
    .catch(error => {
      console.error('Error updating content:', error);
      
      // Show error message
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-danger alert-dismissible fade show';
      alertDiv.innerHTML = `
        <strong>Error!</strong> Failed to save changes. Please try again.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      document.querySelector('.card-body').prepend(alertDiv);
    })
    .finally(() => {
      // Restore button state
      saveButton.innerHTML = originalButtonText;
      saveButton.disabled = false;
    });
  }

  // Function to handle file selection
  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Check if file is an image
    if (file.type.startsWith('image/')) {
      // Create object URL for preview
      const objectUrl = URL.createObjectURL(file);
      
      // Prepare media object
      currentMedia = {
        type: 'image',
        file: file,
        url: objectUrl
      };
      
      // Update gallery with new media immediately
      updateGallery(currentMedia);
      
      // Upload file to server
      uploadMediaToServer(file, contentId).then(response => {
        if (response && response.url) {
          // Update the currentMedia with the server URL
          currentMedia.serverUrl = response.url;
          currentMedia.url = response.url;
          // Update the gallery again with the final URL
          updateGallery(currentMedia);
        }
      });
    } else {
      alert('Please select an image file.');
    }
  }

  // Function to update the gallery with images from API
  function updateGallery(content) {
    const galleryContainer = document.getElementById('image-preview-container');
    if (!galleryContainer) return;
    
    // Get the image card and add button elements
    const imageCard = galleryContainer.querySelector('.position-relative');
    const addButton = document.getElementById('add-image-btn');
    
    if (!content) {
      // If no content, show add button and hide image card
      if (addButton) addButton.classList.remove('d-none');
      if (imageCard) imageCard.closest('.col-12').classList.add('d-none');
      return;
    }
    
    // Update the image source
    const img = imageCard.querySelector('img');
    if (img) {
      img.src = content.url || content;
      img.alt = content.alt || "Hero Image";
    }
    
    // Show image card and hide add button
    if (imageCard) imageCard.closest('.col-12').classList.remove('d-none');
    if (addButton) addButton.classList.add('d-none');
  }

  // Function to upload media to server
  async function uploadMediaToServer(file, contentId) {
    if (!file) return null;
    
    // JWT Token for authorization
    const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4MDQ5MWRmMzljZmYwNTljMDY1NWZkMSIsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc0NTEzMDA2MywiZXhwIjoxNzQ1MjE2NDYzfQ.X7iaXBMdl1dYL15owKDCHzaWQpmtD_b74askqD5vasw';
    
    // Create FormData
    const formData = new FormData();
    formData.append('images', file);
    
    try {
      // Show loading indicator
      const loadingIndicator = document.createElement('div');
      loadingIndicator.className = 'position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
      loadingIndicator.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
      loadingIndicator.style.zIndex = '10';
      loadingIndicator.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Uploading...</span>
          </div>
          <p class="mt-2 text-primary">Uploading...</p>
        </div>
      `;
      
      // Add loading indicator to the media card
      const mediaCard = document.querySelector('.position-relative');
      if (mediaCard) {
        mediaCard.appendChild(loadingIndicator);
      }
      
      // Upload the image to Cloudinary via your endpoint
      const response = await fetch('http://localhost:5000/api/images', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Upload failed: ' + response.statusText);
      }
      
      const data = await response.json();
      
      // Remove loading indicator
      if (loadingIndicator) {
        loadingIndicator.remove();
      }
      
      // Return the Cloudinary URL
      if (data && data.files) {
        return {
          url: data.files[0].url,
          alt: "Uploaded image",
          width: 1200,
          height: 800,
          order: 1,
          type: 'image'
        };
      }
      
      return null;
    } catch (error) {
      console.error('Error uploading to Cloudinary:', error);
      
      // Remove loading indicator if it exists
      const loadingIndicator = document.querySelector('.position-absolute.top-0');
      if (loadingIndicator) {
        loadingIndicator.remove();
      }
      
      // Show error alert with retry option
      const retry = confirm('Failed to upload image. Would you like to try again?');
      if (retry) {
        // Clear the file input and trigger click again
        const fileInput = document.getElementById('media-upload');
        if (fileInput) {
          fileInput.value = '';
          fileInput.click();
        }
      }
      return null;
    }
  }

  // Initialize event listeners
  document.addEventListener('DOMContentLoaded', function() {
    let fileInput = document.getElementById('media-upload');
    const replaceButton = document.querySelector('.btn-replace-image');
    
    // Function to create a new file input
    function createNewFileInput() {
      const newFileInput = document.createElement('input');
      newFileInput.type = 'file';
      newFileInput.id = 'media-upload';
      newFileInput.accept = 'image/*';
      newFileInput.className = 'd-none';
      newFileInput.addEventListener('change', handleFileSelect);
      return newFileInput;
    }
    
    // Set up file input handler
    if (fileInput) {
      const newFileInput = createNewFileInput();
      fileInput.parentNode.replaceChild(newFileInput, fileInput);
      fileInput = newFileInput;
    }
    
    // Set up replace button handler
    if (replaceButton) {
      replaceButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (fileInput) {
          fileInput.click();
        }
      });
    }
  });
</script>